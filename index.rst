:tocdepth: 1

.. sectnum::


Abstract
========

In order to calibrate the AuxTel instruments, particularly the LATISS spectrograph, we want to illuminate the focal plane with monochromatic light at a range of wavelengths. This tech note describes the Rubin Observatory Auxilliary Telescope Calibration Illumination System, its basic operation, and a test dataset.

Overview
================
The Auxilliary Telescope (AuxTel) Calibration Illumination System will be used to illuminate the white calibration screen in the AuxTel with a tunable light source, ranging in wavelength from 350-1200 nm. The illumination system will sit on the dome floor directly below the calibration screen. 

The system was developed and built in Tucson. This document is meant to give an overview of the system and document the assembly and integration process of the system when shipped to Chile. This document also includes an overview of how the system should be operated with sample code, and links to all documentation related to this system so it can be more readily accessed. 

The work to prepare this subsystem for shipment was tracked in the JIRA Epic `SITCOM-259c <https://jira.lsstcorp.org/browse/SITCOM-259>`__.

Some documentation on this system can be accessed on `Docushare Collection-11943 <https://docushare.lsst.org/docushare/dsweb/View/Collection-11943>`__.

There are additional details about control of the LabJack in `Tech Note 36 <https://tstn-036.lsst.io>`__.
An overview of the data is in a Jupyter Notebook in the github for this tech note. 


Hardware
==============
There are five main functional elements of the AuxTel Illumination System:

1. **The White Light Source** supplies the light, and requires a **chiller** to remove heat from the beam.
2. **The Monochromator** changes the wavelength of the output light.
3. **Optics** deliver the light to the calibration screen. There is a shutter that can be opened when using the illumination system.
4. The **Electrometer** and **Fiber Spectrograph** are used to monitor the output beam. 
5. The **Electronics Cabinet** provides power and control to the other hardware. 

These elements are integrated on a large, heavy table. The White light source, monochromator, and optics are all housed in a light tight box. 

White Light Source
------------------
The white light source is a KiloArc Lamp built by Optical Building Blocks. It can output white light with a power of 800 - 1200 W. This light is directed into the monochromator.

Because of the heat generated by such a lamp, before sending the light into the monochromator, the light travels through a water source which absorbs much of the infrared wavelengths. This water heats up, so the white light source must be operated with a chiller, discussed below. The chiller should keep the water cool enough, but if there is ever a situation where there is too much heat being sent into the monochromator, there is a thermal fuse glued attached to the entrance to the monochromator. When it hits a certain temperature it will trigger the emergency stop. On the mountain, there are also temperatures that will freeze the water in the cell. In the event of this occurance, there are heaters that are attached to the cell which will be turned on at a certain temperature, as determined by the operator. The heaters are controlled by an `Omron temperature Controller <http://products.omron.us/item/in-panel-controllers/e5dc/e5dc-qx2dsm-002>`__

The thermal fuses are set to turn off the power at 50C (TBC) and the heaters will turn on when the cell reaches 10C (TBC).

The white light source can either be manually or remotely controlled. It is important to toggle which mode you are using on the back of the white light source. We use a LabJack to control the WLS, receive errors and set the power. Details on the LabJack control of the WLS are found in `tech note 36 <https://tstn-036.lsst.io>`__.

There are fans internal to the WLS which blow air out of a hole at the top. Secured to this hole is an aluminum duct that pushes the air outside of the enclosed area.

There are two cables that come from the WLS: one for commanding the power level and the other to receive status and error messages. 

Documentation on the White Light Source can be found on Docushare `here <https://docushare.lsst.org/docushare/dsweb/View/Collection-5178>`__

Chiller
---------
The chiller is used to cool the water cell in the white light source. This uses a mixture of ethanol and water (50/50)?? to carry heat from a shell surrounding the main water cell. The ethanol helps the water in these tubes from freezing. It does not actually pump the water in and out of the cell, but rather carries heat from tubes surrounding the water cell. The control is on the water coming back to the chiller so there is likely to be some delay in large temperature swings. The temperature should be set to 25C (TBC).

The chiller is controlled via connected to a serial device server (RS-232 to ethernet). The serial device server must run at 9600 baud. 

The chiller must be on for a minimum of 15 minutes after the white light source has been turned off before it can be turned off. The white light source cannot be turned on until the chiller is running. 

The fluid level of the chiller should be checked occasionally. 

The chiller documentation on Docushare can be found `here <https://docushare.lsst.org/docushare/dsweb/View/Collection-5177>`__

Monochromator
-------------
The monochromator is essentially a spectrometer. With the incoming white light, it can output any wavelength from 0 - 1200 nm with fairly high resolution. We will only use it in the range of 350 - 1200 nm. The monochromator is the Horiba iHR 320 Fully Automated Imaging Spectrometer. There are two 1200 gr/mm gratings: one centered at 400 nm (blue) and one at 750 nm (red). These gratings both have a spectral dispersion of :math:`\sim2.31` nm/mm. It also includes a mirror. There are two slits, both of which can be adjusted from 0-5mm, but not including 5mm.  The "Entry" slit is where the light from the white light source enters the monochromator and the "Exit" is where the light exits the monochromator as a "single" wavelength. The monochromator uses very little power at 12V to change the slit width, the wavelength, and the grating. 

The software for the monochromator is run on a Windows Machine, mounted on an Embedded Systems minicontroller. It is connected via USB to this windows machine. When first starting up, the windows machine must be accessed via Remote Desktop for the initialization process. Once that has completed, the CSC can be used to control the Monochromator.

The monochromator is secured with it's three feet mounted to the table. They should be adjusted until the monochromator is level with the white light source.

The manual can be found on Docushare `here <https://docushare.lsst.org/docushare/dsweb/View/Collection-5178>`__

Fiber Spectrograph
------------------
The fiber spectrograph used is an Avantes SensLine AvaSpecULS2048x64TEC-EVO, with a wavelength range of 200-1160 nm. An optical fiber runs from the fiber spectrograph and samples the light from the optical path after it exits from the monochromator. 

The fiber spectrograph is controlled via USB that runs directly from the electrometer to a linux control computer (loonie) in the electronics cabinet. It can be commanded via CSC. 

We also have a fiber illuminator, which can be used to calibrate the Fiber Spectrograph. Power is avaialble for the illuminator on the table, but we expect that the illuminator will only be installed when needed. When we want to calibrate the fiber spectrograph, simply move the fiber from the optical path and install it into the illuminator.

Electrometer
------------
The electrometer used is the Keithley 6517B. It reads the current from a Hammatsu Si S2281 Series photodiode. The photodiode samples the light on the edge of the optical path. It does not measure the total brightness but rather any changes in irradiance from day to day and even throughout a daily operation. 

The electrometer is controlled via a Serial Device Server, the MOXA Nport 5100. Reminder that this will need to be set to a baud rate of 9600. 

The electrometer can be run in charge or current mode. We recommend running it in current mode for this application. See the `CSC XML documentation <https://ts-xml.lsst.io/sal_interfaces/Electrometer.html>`__ for more information. 

The electometer sits in the electronics box and the cable from the photodiode is routed from the top of the table. 

Information on the electrometer and photodiode can be found on Docushare `here <https://docushare.lsst.org/docushare/dsweb/View/Collection-5176>`__

Optics
------
There are three optical that deliver the beam from the monochromator to the calibration screen. The first is a cylindrical lens (CKX20) that shapes the beam and can be rotated. The light then goes to an asphere (Thorlab ACL7560U-A) and then to a fold mirror that reflects the light straight up through the shutter. The optical design for this system can be found on `Docushare <https://docushare.lsst.org/docushare/dsweb/View/Collection-11943>`__.

The cylindrical lens should sit 55mm from the exit slit of the monochromator. The asphere should be aligned with the cylindrical lens, and its front face should sit 80mm from it. The mirror should have an ~45deg angle and sit ~56mm from the back of the asphere. 

Shutter system
--------------
In order to both keep light enclosed when not needed and also to keep dust out of the illumination system, there is a shutter for the output of the beam. The beam travels through glass when the shutter is opened. The shutter can only be commanded fully open or fully closed, not at a point in between. When the shutter has reached one limit or another, it will hit a switch which will confirm to software that it has indeed reached the end of travel. The linear actuator is attached to the top of the structure so must be disassembled before the top of the box can be moved. 

The linear actuator that moves the shutter is controlled with the LabJack. More information can be found on that in `tech note 36 <https://tstn-036.lsst.io>`__.


Electronics Cabinet
-------------------
The electronics cabinet must be turned off before opening. Inside the cabinet there is a thermostat and fan that keeps the electronics cooled. The thermostat is set at 20C (TBC). 

The cabinet includes the control computer (loonie) and the windown machine for the monochromator, both of which are embedded SBCs. There are two serial device servers for the electrometer and chiller and the LabJack with custom board. There are 5V, 12V and 24V voltage supplies, all of which plug into an 8-outlet PDU.

The electronics cabinet is powered by 220Vac from the dome. Additionally, 5 ethernet cables are needed to run into the electronics cabinet for: electrometer serial device server, chiller serial device server, control computer (loonie), monochromator windows machine, LabJack, PDU. 

.. figure:: /_static/AuxTel_Ill_Functional_Layout_2.png
   :name: functional-diagram
   :target: ../_images/AuxTel_Ill_Functional_Layout_2.png
   :alt: Functional Diagram

The PDU outlets are ordered as follows:

+--------+--------------------+
| Outlet | Name               |
+--------+--------------------+
| 1      | Chiller            |
+--------+--------------------+
| 2      | Electrometer       |
+--------+--------------------+
| 3      | White Light Source |
+--------+--------------------+
| 4      | Fiber Spectrograph |
+--------+--------------------+
| 5      | Monochromator      |
+--------+--------------------+
| 6      | 5V                 |
+--------+--------------------+
| 7      | 12V                |
+--------+--------------------+
| 8      | 24V                |
+--------+--------------------+

Structure
---------
The white light source and monochromator sit on a table surrounded by sturdy black cardboard used to create a fully black environment inside. There are thru-holes on the table for the cables that run to the electronics cabinet which is secured below the table. The chiller is also secured below the table. 

The linear actuator that drives the shutter sits on the top of the structure and must be disconnected before the top is removed. 


Setup
=====

Mechanical and Electrical Assembly
----------------------------------
There are three crates that were shipped to Chile from Tucson that contain all necessary hardware for the AuxTel Calibration Illumination System. The list of what was shipped in which crate can be found on `this confluence page <https://confluence.lsstcorp.org/display/LTS/AuxTel+Illumination+System>`__.

Follow this general list of activties to assemble the AuxTel Illumination System

.. figure:: /_static/full_open.png
   :name: img1
   :target: ../_images/full_open.png
   :alt: img1

#. Confirm contents of crates
#. Assemble table
#. Plug in electronics cabinet to power and ethernet to get ball rolling on bringing everything online
#. Install shroud on table
#. Install WLS on table
#. Fill water cell with water
#. Install thermal fuse onto plate
#. Connect heaters to table and then install on water cell

    .. figure:: /_static/heater_wires.png
       :name: heater_wires
       :target: ../_images/heater_wires.png
       :alt: heater_wires
       :scale: 15 %

#. Install monochromator and align with WLS

    .. figure:: /_static/mono_wls_connect.png
       :name: mono_wls_connect
       :target: ../_images/mono_wls_connect.png
       :alt: mono_wls_connect
       :scale: 15 %

#. Secure WLS and monochromator
#. Install chiller tubes to water cell
#. Install exhaust for WLS

    .. figure:: /_static/mounted_exhaust.png
       :name: mounted_exhaust
       :target: ../_images/mounted_exhaust.png
       :alt: mounted_exhaust
       :scale: 15 %

    .. figure:: /_static/exhaust_tube.png
       :name: exhaust_tube
       :target: ../_images/exhaust_tube.png
       :alt: exhaust_tube
       :scale: 15 %

#. Install linear actuator

    .. figure:: /_static/linact.png
       :name: linact
       :target: ../_images/linact.png
       :alt: linact
       :scale: 15 %

#. Install electronics cabinet onto table - first unpower, etc.

    .. figure:: /_static/elec_cab_secure.png
       :name: elec_cab_secure
       :target: ../_images/elec_cab_secure.png
       :alt: elec_cab_secure
       :scale: 15 %

    .. figure:: /_static/elec_cab_right.png
       :name: elec_cab_right
       :target: ../_images/elec_cab_right.png
       :alt: elec_cab_right
       :scale: 15 %

    .. figure:: /_static/elec_cab_left.png
       :name: elec_cab_left
       :target: ../_images/elec_cab_left.png
       :alt: elec_cab_left
       :scale: 15 %

#. Route all cables through table
#. Install electrometer into electronics cabinet
#. Connect all cables, etc.

    .. figure:: /_static/wls_cables.png
       :name: wls_cables
       :target: ../_images/wls_cables.png
       :alt: wls_cables
       :scale: 15 %

    .. figure:: /_static/mono_cables.png
       :name: mono_cables
       :target: ../_images/mono_cables.png
       :alt: mono _cables
       :scale: 15 %

#. Fill chiller with water/ethanol mixture and connect all tubes
#. Install fiber spectrograph

    .. figure:: /_static/spectro.png
       :name: spectro
       :target: ../_images/spectro.png
       :alt: spectro
       :scale: 15 %

#. Setup optics

    .. figure:: /_static/optics_top.png
       :name: optics_top
       :target: ../_images/optics_top.png
       :alt: optics_top
       :scale: 15 %

#. Install glass window in shutter
#. Assemble shutter
#. Install limit switches

    .. figure:: /_static/open_shutter.png
       :name: open_shutter
       :target: ../_images/open_shutter.png
       :alt: open_shutter
       :scale: 15 %

    .. figure:: /_static/shutter_open_2.png
       :name: shutter_open2
       :target: ../_images/shutter_open_2.png
       :alt: shutter_open2
       :scale: 15 %

    .. figure:: /_static/shutter_close.png
       :name: shutter_close
       :target: ../_images/shutter_close.png
       :alt: shutter_close
       :scale: 15 %

    .. figure:: /_static/shutter_close_2.png
       :name: shutter_close2
       :target: ../_images/shutter_close_2.png
       :alt: shutter_close2
       :scale: 10 %

#. Open slits on monochromator
#. Confirm that remote control is selected on WLS

Now you are ready to start turning things on and testing things. 

Operational Setup
-----------------
First, addresses for all of the control components will have to be established. That is being tracked in JIRA ticket `IT-4096 <https://jira.lsstcorp.org/browse/IT-4096>`__. 

Make sure that the indexes for each item is correct (for the CSC) and override yaml files are defined and identified.

Then, go to the address for the PDU and confirm that the numbering of the outlets agrees with the table above and what is actually implemented.

You can now power everything up. Initialize the monochromator by logging into the windows machine via remote desktop.

.. figure:: /_static/mono_screen.png
   :name: mono_screen
   :target: ../_images/mono_screen.png
   :alt: mono _screen
   :scale: 10 %

If you can't talk to the LabJack, then use a direct connection via USB to the LabJack and run the `Kipling software <https://labjack.com/blogs/news/kipling-3-1>`__.

If you have any issues with the Moxa devices, go to their address and then:

  - QuickSetup, Select TCP (not Real COM), 9600 Baud, RS-232, Save/Restart
  - The transmission rate is 9600 Baud, 8 data bits, no parity, 1 stop bit and XON / XOFF flow control


Operation
=========
Operation of the AuxTel Illumination system will be detailed and updated in the Observatory Operations Documentation https://obs-ops.lsst.io.

For initial functional testing, use the notebook in ``_static`` folder under this repository https://github.com/lsst-tstn/tstn-032/ as ``AuxTelCalIll_FunctionalTest.ipynb``.

Initial Results
===============
Several tests were run in Tucson before shipping this. The notebook used to run these tests and do the analysis are saved in ``_static`` folder under this repository https://github.com/lsst-tstn/tstn-032/ as ``AuxTelCalIll_FunctionalTest.ipynb``. Below are the results.

The general conclusions are:

#. Takes 30 minutes to 1 hour with lamp on for brightness to be stable

    .. figure:: /_static/power_over_time.png
       :name: power_time
       :target: ../_images/power_over_time.png
       :alt: power_time

#. Grating 0 should be used from 300 - 550nm and Grating 1 should be sued from 550 - 1150nm

    .. figure:: /_static/power_vs_grating.png
       :name: power_vs_grating
       :target: ../_images/power_vs_grating.png
       :alt: power_vs_grating

#. Width of lines in wavelength ~10nm

    .. figure:: /_static/stability.png
       :name: stability
       :target: ../_images/stability.png
       :alt: stability

#. More work should be done on optimizing the slit widths per wavelength, but optimal will likely be around 1 or 2mm on both entrance and exit. 

#. The wavelength offset seems to vary across the spectral range. This needs to be further investigated







.. Make in-text citations with: :cite:`bibkey`.
.. Uncomment to use citations
.. .. rubric:: References
.. 
.. .. bibliography:: local.bib lsstbib/books.bib lsstbib/lsst.bib lsstbib/lsst-dm.bib lsstbib/refs.bib lsstbib/refs_ads.bib
..    :style: lsst_aa
